###########
# BUILDER #
###########

# pull official base image
FROM ghcr.io/osgeo/gdal:ubuntu-small-3.12.0 AS builder

ARG GDAL_VERSION=3.12.0
ARG GDAL_PYTHON_VERSION=3.12.0.post1
ENV GDAL_VERSION=${GDAL_VERSION}
ENV GDAL_PYTHON_VERSION=${GDAL_PYTHON_VERSION}

# install Python tooling for wheel build
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        python3 python3-dev python3-venv python3-pip \
        build-essential git \
        libpq-dev gettext procps \
        pkg-config \
        libproj-dev proj-data proj-bin \
        libgeos-dev \
        libtiff-dev libjpeg-dev libpng-dev libwebp-dev \
        liblzma-dev libzstd-dev zlib1g-dev \
        libsqlite3-dev libspatialite-dev \
        libxml2-dev libexpat1-dev libcfitsio-dev \
        libopenjp2-7-dev \
        libcurl4-openssl-dev libssl-dev \
        libhdf5-dev libnetcdf-dev \
    && python3 -m venv /opt/venv \
    && rm -rf /var/lib/apt/lists/*

ENV VIRTUAL_ENV=/opt/venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

RUN pip install --upgrade pip setuptools wheel

# Install GDAL Python bindings first to match the installed GDAL version
# Using .post1 version which is compatible with GDAL 3.12.0
# This ensures packages like fiona and geopandas can build properly
RUN pip install --no-cache-dir "gdal==${GDAL_PYTHON_VERSION}"

# set work directory
WORKDIR /usr/src/app

#PYTHONDONTWRITEBYTECODE=1 tell Python to not write bytecode (.pyc) and __pycache__ directory on local env.
ENV PYTHONUNBUFFERED 1
ENV PYTHONDONTWRITEBYTECODE 1

# install dependencies (removed --no-deps to allow proper dependency resolution)
COPY ./requirements.txt .
RUN pip wheel --no-cache-dir --wheel-dir /usr/src/app/wheels -r requirements.txt

#########
# FINAL #
#########

FROM ghcr.io/osgeo/gdal:ubuntu-small-3.12.0

ARG GDAL_VERSION=3.12.0
ARG GDAL_PYTHON_VERSION=3.12.0.post1
ENV GDAL_VERSION=${GDAL_VERSION}
ENV GDAL_PYTHON_VERSION=${GDAL_PYTHON_VERSION}

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        python3 python3-dev python3-venv python3-pip \
        build-essential git netcat-openbsd \
        libpq-dev gettext procps \
        gnupg curl ca-certificates \
        pkg-config \
        libproj-dev proj-data proj-bin \
        libgeos-dev \
        libtiff-dev libjpeg-dev libpng-dev libwebp-dev \
        liblzma-dev libzstd-dev zlib1g-dev \
        libsqlite3-dev libspatialite-dev \
        libxml2-dev libexpat1-dev libcfitsio-dev \
        libopenjp2-7-dev \
        libcurl4-openssl-dev libssl-dev \
        libhdf5-dev libnetcdf-dev \
    && python3 -m venv /opt/venv \
    && echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" \
        | tee /etc/apt/sources.list.d/google-cloud-sdk.list \
    && curl https://packages.cloud.google.com/apt/doc/apt-key.gpg \
        | gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg \
    && apt-get update \
    && apt-get install -y --no-install-recommends google-cloud-cli \
    && rm -rf /var/lib/apt/lists/*

ENV VIRTUAL_ENV=/opt/venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

RUN pip install --upgrade pip setuptools wheel

RUN addgroup --system django \
    && adduser --system --ingroup django django

# Install GDAL Python bindings first to match the installed GDAL version
# Using .post1 version which is compatible with GDAL 3.12.0
RUN pip install --no-cache-dir "gdal==${GDAL_PYTHON_VERSION}"

# install dependencies from wheels
COPY --from=builder /usr/src/app/wheels /wheels
RUN pip install --no-cache-dir /wheels/*

# Install Jupyter-specific packages for faster container restarts
# These packages are installed during build so they persist in the image
RUN pip install --no-cache-dir \
    jupyterlab ipykernel ipywidgets matplotlib seaborn plotly folium python-dotenv redis \
    planetary-computer pystac-client stackstac scipy zarr xee xarray rioxarray dask

# set work directory
WORKDIR /usr/src/app
# COPY ./user_id.json .

COPY ./sv_carbon_removal/start_dev.sh /usr/src/app/start_dev.sh
COPY ./sv_carbon_removal/entrypoint.sh /usr/src/app/entrypoint.sh

RUN sed -i 's/\r$//g' /usr/src/app/start_dev.sh
RUN chmod +x /usr/src/app/start_dev.sh
RUN chown django /usr/src/app/start_dev.sh

#entrypoint is used to process the line endings of the shell scripts, which converts Windows line endings to UNIX line endings.
RUN sed -i 's/\r$//g' /usr/src/app/entrypoint.sh
RUN chmod +x /usr/src/app/entrypoint.sh
RUN chown django /usr/src/app/entrypoint.sh

RUN mkdir /usr/src/media

# Create MapStore config directory for configuration updates
RUN mkdir -p /usr/src/app/mapstore/configs /usr/src/app/auth

# ENTRYPOINT ["/usr/src/app/entrypoint.sh"]