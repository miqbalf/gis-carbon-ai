# 🔐 Unified Authentication Implementation Guide

## 🎯 **Overview**

This guide implements a centralized authentication system where **MapStore handles all user login/logout** and all other services (Django, GeoServer, FastAPI) validate the JWT tokens generated by MapStore.

## 🏗️ **Architecture Flow**

```
User → MapStore Login → JWT Token → All Services Validate Token
```

### **User Experience:**
1. User opens MapStore: `http://localhost:8082/mapstore`
2. User sees login form in MapStore
3. User enters credentials
4. MapStore validates with Django
5. MapStore generates JWT token
6. All services (GeoServer, FastAPI) validate this token
7. User gets access to authenticated layers

## 📋 **Implementation Steps**

### **Step 1: Configure Django for MapStore JWT**

#### **1.1 Update Django Settings**
```python
# backend/sv_carbon_removal/sv_carbon_removal/settings.py

# MapStore JWT Configuration
MAPSTORE_JWT_SECRET = 'gis-carbon-ai-jwt-secret-2024'
MAPSTORE_JWT_ISSUER = 'mapstore-gis-carbon-ai'

# Add MapStore JWT Authentication
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.SessionAuthentication',
        'api.auth.mapstore_jwt.MapStoreJWTAuthentication',  # Add this
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
}
```

#### **1.2 Add Authentication URLs**
```python
# backend/sv_carbon_removal/api/urls.py

from django.urls import path, include
from .auth.mapstore_jwt import MapStoreTokenValidationView, MapStoreLoginView

urlpatterns = [
    # ... existing patterns ...
    path('auth/validate-token/', MapStoreTokenValidationView.as_view(), name='validate-token'),
    path('auth/login/', MapStoreLoginView.as_view(), name='mapstore-login'),
]
```

### **Step 2: Configure FastAPI for MapStore JWT**

#### **2.1 Update FastAPI Main**
```python
# fastapi-gee-service/main.py

from mapstore_auth_middleware import (
    MapStoreJWTMiddleware, 
    require_auth, 
    get_current_user,
    check_layer_permission
)

# Add middleware
app.add_middleware(MapStoreJWTMiddleware, protected_paths=[
    '/tiles/',
    '/analysis/',
    '/layers/gee',
    '/process/'
])

# Update tile endpoint with authentication
@app.get("/tiles/{layer_type}/{layer_name}/{z}/{x}/{y}")
async def get_authenticated_tile(
    layer_type: str,
    layer_name: str,
    z: int,
    x: int,
    y: int,
    user: Optional[Dict[str, Any]] = Depends(get_current_user)
):
    # Check layer access permission
    await check_layer_permission(layer_type, layer_name, user)
    
    # Generate tile...
```

#### **2.2 Add Environment Variables**
```bash
# Add to docker-compose.dev.yml
environment:
  - MAPSTORE_JWT_SECRET=gis-carbon-ai-jwt-secret-2024
  - MAPSTORE_JWT_ISSUER=mapstore-gis-carbon-ai
```

### **Step 3: Configure MapStore Authentication**

#### **3.1 Update MapStore Configuration**
```javascript
// mapstore/localConfig.json
{
  "authentication": {
    "type": "local",
    "loginForm": {
      "enabled": true,
      "title": "GIS Carbon AI Login"
    },
    "jwt": {
      "secret": "gis-carbon-ai-jwt-secret-2024",
      "expiration": 86400,
      "algorithm": "HS256",
      "issuer": "mapstore-gis-carbon-ai"
    }
  },
  "services": {
    "django": {
      "url": "http://localhost:8000",
      "authEndpoint": "/api/auth/validate-token/",
      "loginEndpoint": "/api/auth/login/"
    },
    "fastapi": {
      "url": "http://localhost:8001",
      "authEndpoint": "/auth/validate-token"
    }
  }
}
```

#### **3.2 Create MapStore Authentication Plugin**
```javascript
// mapstore/plugins/UnifiedAuth.js
const UnifiedAuth = {
    name: 'UnifiedAuth',
    component: require('./UnifiedAuthComponent'),
    reducers: {
        unifiedAuth: require('./reducers/unifiedAuth')
    },
    epics: {
        unifiedAuth: require('./epics/unifiedAuth')
    }
};

// UnifiedAuthComponent.js
import React, { useState, useEffect } from 'react';
import { connect } from 'react-redux';

const UnifiedAuthComponent = ({ user, onLogin, onLogout }) => {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);

    const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        
        try {
            // Call Django login endpoint
            const response = await fetch('http://localhost:8000/api/auth/login/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            
            if (response.ok) {
                const userData = await response.json();
                
                // Generate JWT token in MapStore
                const token = generateJWTToken(userData.user);
                
                // Store token and update services
                localStorage.setItem('mapstore_token', token);
                updateServiceConfigurations(token);
                
                onLogin(userData.user);
            }
        } catch (error) {
            console.error('Login failed:', error);
        } finally {
            setLoading(false);
        }
    };

    const generateJWTToken = (user) => {
        // Generate JWT token with user data
        const payload = {
            user_id: user.id,
            username: user.username,
            roles: user.roles,
            permissions: user.permissions,
            exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60), // 24 hours
            iat: Math.floor(Date.now() / 1000),
            iss: 'mapstore-gis-carbon-ai'
        };
        
        // Use a JWT library to sign the token
        return jwt.sign(payload, 'gis-carbon-ai-jwt-secret-2024');
    };

    const updateServiceConfigurations = (token) => {
        // Update all service configurations with token
        window.ConfigUtils.setConfigProp('services.django.authToken', token);
        window.ConfigUtils.setConfigProp('services.fastapi.authToken', token);
        
        // Refresh layer access
        refreshLayerAccess();
    };

    const refreshLayerAccess = async () => {
        const token = localStorage.getItem('mapstore_token');
        
        // Get accessible layers from FastAPI
        const response = await fetch('http://localhost:8001/layers/accessible', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const accessibleLayers = await response.json();
        
        // Update MapStore catalog with accessible layers
        updateCatalogServices(accessibleLayers);
    };

    if (user) {
        return (
            <div className="unified-auth">
                <p>Welcome, {user.username}!</p>
                <button onClick={onLogout}>Logout</button>
            </div>
        );
    }

    return (
        <form onSubmit={handleLogin} className="unified-auth-form">
            <h3>GIS Carbon AI Login</h3>
            <input
                type="text"
                placeholder="Username"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                required
            />
            <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
            />
            <button type="submit" disabled={loading}>
                {loading ? 'Logging in...' : 'Login'}
            </button>
        </form>
    );
};

export default connect(
    state => ({ user: state.unifiedAuth.user }),
    { onLogin: loginUser, onLogout: logoutUser }
)(UnifiedAuthComponent);
```

### **Step 4: Update Docker Configuration**

#### **4.1 Add Environment Variables**
```yaml
# docker-compose.dev.yml

services:
  django:
    environment:
      - MAPSTORE_JWT_SECRET=gis-carbon-ai-jwt-secret-2024
      - MAPSTORE_JWT_ISSUER=mapstore-gis-carbon-ai

  fastapi:
    environment:
      - MAPSTORE_JWT_SECRET=gis-carbon-ai-jwt-secret-2024
      - MAPSTORE_JWT_ISSUER=mapstore-gis-carbon-ai

  mapstore:
    environment:
      - MAPSTORE_JWT_SECRET=gis-carbon-ai-jwt-secret-2024
      - MAPSTORE_JWT_ISSUER=mapstore-gis-carbon-ai
```

## 🧪 **Testing the Implementation**

### **Test 1: Login Flow**
1. Open MapStore: `http://localhost:8082/mapstore`
2. Click login
3. Enter valid credentials
4. Verify JWT token is generated and stored
5. Check that all services receive the token

### **Test 2: Layer Access**
1. Login as different user types (admin, analyst, viewer)
2. Verify access to appropriate layers
3. Test public vs authenticated layers
4. Verify layer access is controlled properly

### **Test 3: Service Integration**
1. Test Django API with JWT token
2. Test FastAPI tile service with JWT token
3. Test GeoServer with JWT token
4. Verify all services validate tokens correctly

## 🔧 **Troubleshooting**

### **Common Issues:**

1. **JWT Secret Mismatch**
   - Ensure all services use the same JWT secret
   - Check environment variables in docker-compose

2. **Token Validation Fails**
   - Verify JWT issuer matches across services
   - Check token expiration settings

3. **Layer Access Issues**
   - Verify user permissions in Django
   - Check layer access control logic in FastAPI

4. **CORS Issues**
   - Ensure CORS is configured for all services
   - Check that MapStore can call other services

## 🎯 **Benefits of This Implementation**

1. **Single Sign-On**: User logs in once in MapStore
2. **Unified Experience**: Consistent authentication across all services
3. **Centralized Management**: All auth logic in MapStore
4. **Secure**: JWT tokens with proper validation
5. **Scalable**: Easy to add new services
6. **User-Friendly**: Familiar MapStore login interface

## 📋 **Next Steps**

1. **Implement the authentication files**
2. **Update Docker configuration**
3. **Test the login flow**
4. **Verify layer access control**
5. **Deploy and test in production**

This implementation ensures that users have a seamless experience where they log in once in MapStore and get access to all authenticated layers across Django, GeoServer, and FastAPI services.
